#cloud-config
# VibeStack KASM Server - Ansible Ready Configuration
# This script prepares the server with Ansible and configuration playbooks

package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - git
  - curl
  - wget
  - software-properties-common
  - resolvconf

write_files:
  - path: /opt/vibestack-ansible/kasm/install.yml
    content: |
      ---
      # KASM Workspaces Installation Playbook
      # Installs KASM on OCI ARM64 instances

      - name: Install KASM Workspaces
        hosts: localhost
        become: yes
        gather_facts: yes
        vars:
          docker_arch: "{{ 'arm64' if ansible_architecture == 'aarch64' else 'amd64' if ansible_architecture == 'x86_64' else ansible_architecture }}"
          kasm_version: "1.17.0"
          swap_file: "/swapfile"
          swap_size: "2G"

        tasks:
          - name: System information
            debug:
              msg:
                - "🚀 KASM Workspaces Installation"
                - "📋 Host: {{ ansible_hostname }}"
                - "🏗️ Architecture: {{ ansible_architecture }} (Docker: {{ docker_arch }})"
                - "💿 Distribution: {{ ansible_distribution }} {{ ansible_distribution_version }}"

          - name: Update system packages
            apt:
              update_cache: yes
              upgrade: dist
              cache_valid_time: 3600

          - name: Install required packages
            apt:
              name:
                - ca-certificates
                - curl
                - gnupg
                - lsb-release
                - software-properties-common
                - apt-transport-https
              state: present

          - name: Configure swap space
            block:
              - name: Check if swap file exists
                stat:
                  path: "{{ swap_file }}"
                register: swap_file_stat

              - name: Create swap file
                command: fallocate -l {{ swap_size }} {{ swap_file }}
                when: not swap_file_stat.stat.exists

              - name: Set swap file permissions
                file:
                  path: "{{ swap_file }}"
                  mode: '0600'
                when: not swap_file_stat.stat.exists

              - name: Make swap file
                command: mkswap {{ swap_file }}
                when: not swap_file_stat.stat.exists

              - name: Enable swap
                command: swapon {{ swap_file }}
                when: not swap_file_stat.stat.exists

              - name: Add swap to fstab
                lineinfile:
                  path: /etc/fstab
                  line: "{{ swap_file }} none swap sw 0 0"
                  create: yes

          - name: Install Docker
            block:
              - name: Check if Docker is installed
                command: docker --version
                register: docker_check
                failed_when: false
                changed_when: false

              - name: Docker installation status
                debug:
                  msg: "Docker status: {{ 'Already installed' if docker_check.rc == 0 else 'Not installed' }}"

              - name: Remove old Docker packages
                apt:
                  name:
                    - docker
                    - docker-engine
                    - docker.io
                    - containerd
                    - runc
                  state: absent
                when: docker_check.rc != 0

              - name: Remove conflicting repository files
                file:
                  path: "{{ item }}"
                  state: absent
                loop:
                  - /etc/apt/sources.list.d/docker.list
                  - /etc/apt/keyrings/docker.gpg
                  - /usr/share/keyrings/docker-archive-keyring.gpg
                when: docker_check.rc != 0

              - name: Create keyrings directory
                file:
                  path: /etc/apt/keyrings
                  state: directory
                  mode: '0755'
                when: docker_check.rc != 0

              - name: Add Docker GPG key
                shell: |
                  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
                  chmod a+r /etc/apt/keyrings/docker.gpg
                when: docker_check.rc != 0

              - name: Add Docker repository
                shell: |
                  echo "deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable" > /etc/apt/sources.list.d/docker.list
                when: docker_check.rc != 0

              - name: Update apt cache after adding Docker repo
                apt:
                  update_cache: yes
                when: docker_check.rc != 0

              - name: Install Docker packages
                apt:
                  name:
                    - docker-ce
                    - docker-ce-cli
                    - containerd.io
                    - docker-buildx-plugin
                    - docker-compose-plugin
                  state: present
                  update_cache: yes
                when: docker_check.rc != 0

              - name: Add ubuntu user to docker group
                user:
                  name: ubuntu
                  groups: docker
                  append: yes

              - name: Enable and start Docker service
                systemd:
                  name: docker
                  enabled: yes
                  state: started

          - name: Download and install KASM Workspaces
            block:
              - name: Create KASM directory
                file:
                  path: /tmp/kasm_install
                  state: directory
                  mode: '0755'

              - name: Download KASM installer
                get_url:
                  url: "https://kasm-static-content.s3.amazonaws.com/kasm_release_{{ kasm_version }}.tar.gz"
                  dest: /tmp/kasm_install/kasm_release.tar.gz
                  mode: '0644'

              - name: Extract KASM installer
                unarchive:
                  src: /tmp/kasm_install/kasm_release.tar.gz
                  dest: /tmp/kasm_install
                  remote_src: yes

              - name: Run KASM installation
                shell: |
                  cd /tmp/kasm_install/kasm_release
                  ./install.sh --accept-eula --swap-size {{ swap_size }}
                args:
                  creates: /opt/kasm/current

              - name: Get KASM admin credentials
                slurp:
                  src: /opt/kasm/current/conf/app/admin_creds.txt
                register: admin_creds
                ignore_errors: yes

              - name: Display KASM access information
                debug:
                  msg:
                    - "✅ KASM Installation Complete!"
                    - "Access URL: https://{{ ansible_default_ipv4.address }}"
                    - "Admin credentials can be found in: /opt/kasm/current/conf/app/admin_creds.txt"
    permissions: '0644'

  - path: /opt/vibestack-ansible/README.md
    content: |
      # VibeStack Ansible Configuration

      This directory contains Ansible playbooks for configuring your VibeStack servers.

      ## Quick Start

      ### Configure KASM
      ```bash
      cd /opt/vibestack-ansible
      ansible-playbook kasm/install.yml
      ```

      ### Access KASM
      After installation, open your browser to:
      https://$(curl -s ifconfig.me)

      ## What Gets Installed

      - **Docker**: Container runtime for KASM
      - **KASM Workspaces**: Browser-based remote desktop platform
      - **Swap**: 2GB swap file for better performance
      - **Initial Setup**: Ready for web-based configuration

      ## Next Steps

      1. Run the installation playbook above
      2. Open KASM in your browser (HTTPS)
      3. Login with admin credentials from: /opt/kasm/current/conf/app/admin_creds.txt
      4. Configure workspaces and users

      ## Troubleshooting

      - Check KASM status: `sudo docker ps`
      - View admin credentials: `sudo cat /opt/kasm/current/conf/app/admin_creds.txt`
      - Restart KASM: `cd /opt/kasm/current && sudo docker compose restart`
    permissions: '0644'

runcmd:
  - echo 'Configuring DNS resolution...'
  - echo 'nameserver 8.8.8.8' | tee /etc/resolv.conf
  - echo 'nameserver 1.1.1.1' | tee -a /etc/resolv.conf
  - systemctl restart systemd-resolved
  - echo 'Installing Ansible and collections...'
  - pip3 install ansible
  - pip3 install docker
  - ansible-galaxy collection install community.general
  - ansible-galaxy collection install community.docker
  - ansible-galaxy collection install ansible.posix
  - chown -R ubuntu:ubuntu /opt/vibestack-ansible
  - echo 'Ansible environment ready'
  - echo 'Configuration files in /opt/vibestack-ansible/'
  - echo 'To configure run cd /opt/vibestack-ansible && ansible-playbook kasm/install.yml'

final_message: |
  VibeStack KASM server is ready!

  Next steps:
  1. SSH into your server
  2. Run: cd /opt/vibestack-ansible && ansible-playbook kasm/install.yml
  3. Access KASM at https://[YOUR-SERVER-IP]

  The server has been configured with Ansible and all necessary playbooks.